{# 
   Template de la page panier
   
   CE QUE JE FAIS :
   - J'affiche tous les articles du panier avec leurs quantit√©s
   - Je propose des boutons +/- pour modifier les quantit√©s
   - J'affiche le total en temps r√©el
   - Je g√®re le cas du panier vide avec un message
   - Je fournis des boutons pour vider le panier ou continuer les achats
   
   VARIABLES RE√áUES DU CONTROLLER :
   - cartItems : array des articles du panier
   - totalQuantity : nombre total d'articles
   - totalPrice : prix total en euros
   - isEmpty : true si le panier est vide
#}

{% extends 'base.html.twig' %}

{% block title %}Mon panier - Boucherie Eysa{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('build/app.css') }}">
{% endblock %}

{% block body %}
<div class="cart-page">
    
    {# EN-T√äTE DE LA PAGE PANIER #}
    <section class="cart-header section-eysa">
        <div class="cc-container">
            <div class="cart-header-content">
                <h1 class="title-eysa-2">
                    <i class="fas fa-shopping-cart"></i>
                    Mon panier
                </h1>
                
                {% if not isEmpty %}
                    <p class="cart-summary-text">
                        <strong>{{ totalQuantity }}</strong> article{{ totalQuantity > 1 ? 's' : '' }} 
                        pour un total de <strong>{{ cart.totalTTC|number_format(2, ',', ' ') }} ‚Ç¨ TTC</strong>
                    </p>
                {% endif %}
            </div>
        </div>
    </section>

    {# CONTENU PRINCIPAL DU PANIER #}
    <section class="cart-content section-eysa-alt">
        <div class="cc-container">
            
            {% if isEmpty %}
                {# PANIER VIDE - Message sympathique avec actions #}
                <div class="cart-empty">
                    <div class="empty-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h2 class="title-eysa-3">Votre panier est vide</h2>
                    <p class="text-eysa-body">
                        D√©couvrez notre s√©lection de viandes fra√Æches et commencez vos achats !
                    </p>
                    <div class="empty-actions">
                        <a href="{{ path('app_products') }}" class="btn-eysa btn-eysa-primary">
                            <i class="fas fa-meat"></i>
                            D√©couvrir nos produits
                        </a>
                        <a href="{{ path('app_category_index') }}" class="btn-eysa btn-eysa-secondary">
                            <i class="fas fa-list"></i>
                            Voir les cat√©gories
                        </a>
                    </div>
                </div>
                
            {% else %}
                {# PANIER AVEC ARTICLES #}
                <div class="cart-items-container">
                    
                    {# LISTE DES ARTICLES #}
                    <div class="cart-items-list">
                        {% for cartItem in cartItems %}
                            <div class="cart-item card-eysa" data-product-id="{{ cartItem.product.id }}">
                                
                                {# IMAGE DU PRODUIT #}
                                <div class="cart-item-image">
                                    {% if cartItem.product.image %}
                                        <img src="{{ asset('images/' ~ cartItem.product.image) }}" 
                                             alt="{{ cartItem.product.name }}"
                                             loading="lazy">
                                    {% else %}
                                        <div class="product-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                {# INFORMATIONS DU PRODUIT #}
                                <div class="cart-item-info">
                                    <h3 class="product-name">
                                        <a href="{{ path('app_product_show', {id: cartItem.product.id}) }}">
                                            {{ cartItem.product.name }}
                                        </a>
                                    </h3>
                                    
                                    {% if cartItem.product.description %}
                                        <p class="product-description">
                                            {{ cartItem.product.description|slice(0, 100) }}...
                                        </p>
                                    {% endif %}
                                    
                                    <div class="item-details">
                                        <span class="unit-price">
                                            Prix unitaire : <strong>{{ cartItem.unitPrice|number_format(2, ',', ' ') }} ‚Ç¨</strong>
                                        </span>
                                        {# J'enl√®ve les contr√¥les de quantit√© - pas de sens pour une boucherie #}
                                    </div>
                                </div>
                                
                                {# PRIX TOTAL ET SUPPRESSION UNIQUEMENT #}
                                <div class="cart-item-controls">
                                    {# TOTAL DE CET ARTICLE #}
                                    <div class="item-total">
                                        <span class="total-label">Total :</span>
                                        <span class="total-amount" data-product-id="{{ cartItem.product.id }}">
                                            {{ cartItem.total|number_format(2, ',', ' ') }} ‚Ç¨
                                        </span>
                                    </div>
                                    
                                    {# BOUTON SUPPRIMER UNIQUEMENT #}
                                    <button type="button" 
                                            class="btn-remove"
                                            data-product-id="{{ cartItem.product.id }}"
                                            title="Retirer du panier">
                                        <i class="fas fa-trash"></i>
                                        Supprimer
                                    </button>
                                </div>
                                
                            </div>
                        {% endfor %}
                    </div>
                    
                    {# R√âSUM√â ET ACTIONS #}
                    <div class="cart-summary">
                        <div class="summary-card card-eysa">
                            <h3 class="title-eysa-3">R√©sum√© de la commande</h3>
                            
                            <div class="summary-details">
                                <div class="summary-line">
                                    <span>Articles ({{ totalQuantity }}) :</span>
                                    <span id="cart-total">{{ cart.totalTTC|number_format(2, ',', ' ') }} ‚Ç¨ TTC</span>
                                </div>
                                
                                {# LIGNE TVA - TRANSPARENCE #}
                                <div class="summary-line tax-info">
                                    <span class="tax-label">
                                        <small>dont TVA ({{ cart.taxRate }}%) :</small>
                                    </span>
                                    <span class="tax-amount">
                                        <small>{{ cart.taxAmount|number_format(2, ',', ' ') }} ‚Ç¨</small>
                                    </span>
                                </div>
                                
                                <div class="summary-line shipping">
                                    <span>Livraison :</span>
                                    <span class="free">Retrait gratuit</span>
                                </div>
                                
                                <hr class="summary-divider">
                                
                                <div class="summary-line total">
                                    <strong>
                                        <span>Total TTC :</span>
                                        <span id="cart-final-total">{{ cart.totalTTC|number_format(2, ',', ' ') }} ‚Ç¨</span>
                                    </strong>
                                </div>
                            </div>
                            
                            {# ACTIONS PRINCIPALES #}
                            <div class="cart-actions">
                                <button type="button" 
                                        class="btn-eysa btn-eysa-primary btn-checkout">
                                    <i class="fas fa-credit-card"></i>
                                    Finaliser ma commande
                                </button>
                                
                                <a href="{{ path('app_products') }}" 
                                   class="btn-eysa btn-eysa-secondary">
                                    <i class="fas fa-arrow-left"></i>
                                    Continuer mes achats
                                </a>
                                
                                <button type="button" 
                                        class="btn-clear-cart"
                                        onclick="confirmClearCart()">
                                    <i class="fas fa-trash"></i>
                                    Vider le panier
                                </button>
                            </div>
                        </div>
                    </div>
                    
                </div>
            {% endif %}
            
        </div>
    </section>
    
</div>

{# MODAL DE CONFIRMATION POUR VIDER LE PANIER #}
<div id="confirm-clear-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Confirmer</h3>
        <p>√ätes-vous s√ªr de vouloir vider votre panier ?</p>
        <div class="modal-actions">
            <button type="button" class="btn-eysa btn-eysa-primary" onclick="clearCart()">
                Oui, vider le panier
            </button>
            <button type="button" class="btn-eysa btn-eysa-secondary" onclick="closeModal()">
                Annuler
            </button>
        </div>
    </div>
</div>

{# NOTIFICATION TOAST #}
<div id="cart-toast" class="toast" style="display: none;">
    <span id="toast-message"></span>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // üõí JAVASCRIPT POUR LA PAGE PANIER
        // Je g√®re toutes les interactions : +/-, suppression, vidage, etc.
        
        /**
         * Je g√®re les boutons de quantit√© (+/-)
         * COMMENT JE FONCTIONNE :
         * 1. J'√©coute les clics sur les boutons +/-
         * 2. J'envoie une requ√™te AJAX pour modifier la quantit√©
         * 3. Je mets √† jour l'affichage sans recharger la page
         */
        document.addEventListener('DOMContentLoaded', function() {
            
            // J'√©coute tous les boutons de quantit√©
            document.querySelectorAll('.btn-quantity').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.dataset.productId;
                    const action = this.dataset.action;
                    const quantityInput = document.querySelector(`#quantity-${productId}`);
                    let currentQuantity = parseInt(quantityInput.value);
                    
                    if (action === 'increase') {
                        currentQuantity++;
                    } else if (action === 'decrease') {
                        currentQuantity = Math.max(0, currentQuantity - 1);
                    }
                    
                    updateQuantity(productId, currentQuantity);
                });
            });
            
            // J'√©coute les changements directs dans les inputs de quantit√©
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', function() {
                    const productId = this.dataset.productId;
                    const newQuantity = Math.max(0, parseInt(this.value) || 0);
                    updateQuantity(productId, newQuantity);
                });
            });
            
            // J'√©coute les boutons de suppression
            document.querySelectorAll('.btn-remove').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.dataset.productId;
                    removeProduct(productId);
                });
            });
            
        });
        
        /**
         * Je mets √† jour la quantit√© d'un produit via AJAX
         */
        function updateQuantity(productId, newQuantity) {
            const formData = new FormData();
            formData.append('quantity', newQuantity);
            
            fetch(`/panier/update/${productId}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (newQuantity === 0) {
                        // Je supprime la ligne si quantit√© = 0
                        document.querySelector(`[data-product-id="${productId}"]`).remove();
                    } else {
                        // Je mets √† jour l'affichage
                        document.querySelector(`#quantity-${productId}`).value = newQuantity;
                        updateItemTotal(productId, data.cartSummary);
                    }
                    
                    updateCartTotals(data.cartSummary);
                    showToast(data.message);
                    updateCartBadge(); // Je mets √† jour le badge du header
                    
                    // Si le panier devient vide, je recharge la page
                    if (data.cartSummary.isEmpty) {
                        location.reload();
                    }
                } else {
                    showToast(data.error || 'Erreur lors de la mise √† jour', 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showToast('Erreur de connexion', 'error');
            });
        }
        
        /**
         * Je supprime un produit du panier
         */
        function removeProduct(productId) {
            fetch(`/panier/remove/${productId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Je supprime la ligne du produit
                    document.querySelector(`[data-product-id="${productId}"]`).remove();
                    updateCartTotals(data.cartSummary);
                    showToast(data.message);
                    updateCartBadge();
                    
                    // Si le panier devient vide, je recharge la page
                    if (data.cartSummary.isEmpty) {
                        location.reload();
                    }
                } else {
                    showToast(data.error || 'Erreur lors de la suppression', 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showToast('Erreur de connexion', 'error');
            });
        }
        
        /**
         * Je mets √† jour les totaux affich√©s
         */
        function updateCartTotals(cartSummary) {
            document.getElementById('cart-total').textContent = 
                cartSummary.totalPrice.toFixed(2).replace('.', ',') + ' ‚Ç¨';
            document.getElementById('cart-final-total').textContent = 
                cartSummary.totalPrice.toFixed(2).replace('.', ',') + ' ‚Ç¨';
        }
        
        /**
         * Je mets √† jour le sous-total d'un article
         */
        function updateItemTotal(productId, cartSummary) {
            const item = cartSummary.items.find(item => item.productId == productId);
            if (item) {
                const totalElement = document.querySelector(`[data-product-id="${productId}"] .total-amount`);
                if (totalElement) {
                    totalElement.textContent = item.total.toFixed(2).replace('.', ',') + ' ‚Ç¨';
                }
            }
        }
        
        /**
         * Je mets √† jour le badge du panier dans le header
         */
        function updateCartBadge() {
            fetch('/panier/count')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('cart-count');
                    if (badge) {
                        badge.textContent = data.count;
                        badge.style.display = data.isEmpty ? 'none' : 'block';
                    }
                })
                .catch(error => console.error('Erreur mise √† jour badge:', error));
        }
        
        /**
         * J'affiche une notification toast
         */
        function showToast(message, type = 'success') {
            const toast = document.getElementById('cart-toast');
            const messageSpan = document.getElementById('toast-message');
            
            messageSpan.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        /**
         * Je confirme avant de vider le panier
         */
        function confirmClearCart() {
            document.getElementById('confirm-clear-modal').style.display = 'block';
        }
        
        /**
         * Je vide le panier apr√®s confirmation
         */
        function clearCart() {
            fetch('/panier/clear', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Je recharge pour afficher le panier vide
                } else {
                    showToast(data.error || 'Erreur lors du vidage', 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showToast('Erreur de connexion', 'error');
            });
            
            closeModal();
        }
        
        /**
         * Je ferme la modal
         */
        function closeModal() {
            document.getElementById('confirm-clear-modal').style.display = 'none';
        }
        
    </script>
{% endblock %}
